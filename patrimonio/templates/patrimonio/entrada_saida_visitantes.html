{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="{% static 'patrimonio/css/visitantes.css' %}">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap JS Bundle (inclui Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="icon" href="https://encrypted-tbn2.gstatic.com/faviconV2?url=https://www.nortetech.net&amp;client=VFE&amp;size=64&amp;type=FAVICON&amp;fallback_opts=TYPE,SIZE,URL&amp;nfrp=2" type="image/png">
    <title>{% block title %}Visitantes - PATRIMONIO{% endblock %}</title>
    <style>
        video#webcam {
            width: 100%;
            height: auto;
            border-radius: 8px;
            border: 2px solid #ccc;
        }

        button.btn-success {
            width: 100%;
        }
        #galeria-foto-entrega {
            max-width: 300px;
            position: relative;
        }
        #galeria-foto-entrega .btn-close {
            z-index: 10;
        }
        #galeria-foto-entrega img {
            width: 100%;
            border-radius: 5px;
        }

    </style>
</head>
<body>
    {% include 'patrimonio/includes/sidebar.html' %}
    <div class="main-content" id="mainContent">
        <h1>Tela Visitantes</h1>

        <!-- Bot√µes de A√ß√£o -->
        <div class="mb-4 d-flex gap-2">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#fornecedorModal">
                Novo Fornecedor
            </button>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#entradafornecedorModal">
                Nova Entrada de Fornecedor 
            </button>
        </div>

        <div class="modal fade" id="fornecedorModal" tabindex="-1" aria-labelledby="fornecedorModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-header">
                <h5 class="modal-title" id="fornecedorModalLabel">Novo Fornecedor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                {{ form_fornecedor.as_p }}

                <div id="visitanteFields" style="display:none;">
                    <h6>Informa√ß√µes Visitante</h6>

                    <div class="mb-3">
                        <label for="{{ form_visitante.nome.id_for_label }}" class="form-label">Nome:</label>
                        {{ form_visitante.nome }}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form_visitante.documento.id_for_label }}" class="form-label">Documento:</label>
                        {{ form_visitante.documento }}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form_visitante.motivo_visita.id_for_label }}" class="form-label">Motivo da Visita:</label>
                        {{ form_visitante.motivo_visita }}
                    </div>
                    <!-- Webcam -->
                    <div id="webcam-container" style="margin-top: 1rem;">
                        <h6>Captura de Foto</h6>
                        <video id="webcam" autoplay playsinline style="width: 100%; max-width: 320px; border: 1px solid #ccc;"></video>
                        <canvas id="canvas" style="display: none;"></canvas>
                        <input type="hidden" name="foto_visitante" id="id_foto_visitante">
                        <button type="button" class="btn btn-sm btn-success mt-2" onclick="tirarFoto()">üì∏ Tirar Foto</button>
                        <div id="foto-confirmada" class="text-success fw-bold mt-2" style="display: none;">‚úÖ Foto capturada com sucesso!</div>
                        <div id="galeria-foto-visitante" style="display: none; margin-top: 1rem; position: relative;">
                            <img id="imagem-preview-visitante" src="" style="max-width: 320px; border: 2px solid #28a745; border-radius: 5px;">
                            <button type="button" onclick="removerFotoVisitante()" style="position: absolute; top: 0; right: 0; background: red; color: white; border: none; border-radius: 0 0 0 5px; padding: 4px 8px; font-weight: bold;">X</button>
                        </div>

                    </div>
                </div>
                <div id="fornecedorServicoFields" style="display:none;">
                    <h6>Informa√ß√µes Fornecedor/Servi√ßo</h6>

                    <div class="mb-3">
                        <label for="{{ form_fornecedor_servico.nome_empresa.id_for_label }}" class="form-label">Nome da Empresa:</label>
                        {{ form_fornecedor_servico.nome_empresa }}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form_fornecedor_servico.nome_representante.id_for_label }}" class="form-label">Nome do Representante:</label>
                        {{ form_fornecedor_servico.nome_representante }}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form_fornecedor_servico.documento.id_for_label }}" class="form-label">Documento:</label>
                        {{ form_fornecedor_servico.documento }}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form_fornecedor_servico.atividade_servico.id_for_label }}" class="form-label">Atividade do Servi√ßo:</label>
                        {{ form_fornecedor_servico.atividade_servico }}
                    </div>

                    <!-- Campo oculto para imagem base64 -->
                    {{ form_fornecedor_servico.foto_webcam }}

                    <!-- Captura por webcam -->
                    <div id="webcam-container-servico" style="margin-top: 1rem;">
                        <h6>Captura de Foto</h6>
                        <video id="webcam-servico" autoplay playsinline style="width: 100%; max-width: 320px; border: 1px solid #ccc;"></video>
                        <canvas id="canvas-servico" style="display: none;"></canvas>
                        <button type="button" class="btn btn-sm btn-success mt-2" onclick="tirarFotoServico()">üì∏ Tirar Foto</button>
                        <div id="foto-confirmada-servico" class="text-success fw-bold mt-2" style="display: none;">‚úÖ Foto capturada com sucesso!</div>
                        <div id="galeria-foto-servico" style="display: none; margin-top: 1rem; position: relative;">
                            <img id="imagem-preview-servico" src="" style="max-width: 320px; border: 2px solid #28a745; border-radius: 5px;">
                            <button type="button" onclick="removerFotoServico()" style="position: absolute; top: 0; right: 0; background: red; color: white; border: none; border-radius: 0 0 0 5px; padding: 4px 8px; font-weight: bold;">X</button>
                        </div>

                    </div>
                </div>

                <div id="entregaFields" style="display:none;">
                    <h6>Informa√ß√µes Entrega</h6>

                    <div class="mb-2">
                        <label for="id_tipo_entrega">Tipo de Entrega</label>
                        {{ form_entrega.tipo_entrega }}
                    </div>

                    <div class="mb-2">
                        <label for="id_descricao_item">Descri√ß√£o do Item</label>
                        {{ form_entrega.descricao_item }}
                    </div>

                    <div class="mb-2">
                        <label for="id_nome_transportadora">Nome da Transportadora</label>
                        {{ form_entrega.nome_transportadora }}
                    </div>

                    <div class="mb-2">
                        <label for="id_nome_entregador">Nome do Entregador</label>
                        {{ form_entrega.nome_entregador }}
                    </div>

                    <div class="mb-2">
                        <label for="id_documentos_entregador">Documentos do Entregador</label>
                        {{ form_entrega.documentos_entregador }}
                    </div>

                    <div class="mb-2">
                        <label for="id_data_hora_recebimento">Data e Hora do Recebimento</label>
                        {{ form_entrega.data_hora_recebimento }}
                    </div>

                    <div class="mb-2">
                        <label for="id_nome_matricula_responsavel">Nome e Matr√≠cula do Respons√°vel</label>
                        {{ form_entrega.nome_matricula_responsavel }}
                    </div>

                    <div class="mb-2">
                        <label for="id_assinatura_responsavel">Assinatura do Respons√°vel</label>
                        {{ form_entrega.assinatura_responsavel }}
                    </div>

                    <div class="mb-2">
                        <label for="id_data_hora_entrega_material">Data e Hora da Entrega do Material</label>
                        {{ form_entrega.data_hora_entrega_material }}
                    </div>

                    {{ form_entrega.foto_webcam }}  <!-- campo hidden para armazenar foto capturada pela webcam -->

                    <!-- Se√ß√£o da webcam -->
                    <div id="webcam-entrega-container" style="display:none;">
                        <h6>Foto da Entrega (Caixa)</h6>
                        <video id="webcam-entrega" autoplay playsinline width="300"></video>
                        <canvas id="canvas-entrega" style="display:none;"></canvas>
                        <input type="hidden" id="id_foto_entrega" name="foto_webcam">
                        <button type="button" class="btn btn-sm btn-success mt-2" onclick="tirarFotoEntrega()">Tirar Foto da Entrega</button>
                        <div id="galeria-foto-entrega" class="position-relative mt-2" style="display: none;">
                            <button type="button" onclick="removerFotoEntrega()" class="btn-close position-absolute top-0 end-0 m-1" aria-label="Fechar"></button>
                            <img id="imagem-preview-entrega" src="" alt="Foto da Entrega" class="img-thumbnail" style="max-width: 100%; height: auto;">
                        </div>
                    </div>
                </div>
                <script>
                    let webcamStarted = false;
                    let webcamStream = null;

                    let webcamServicoStarted = false;
                    let webcamServicoStream = null;

                    let webcamEntregaStarted = false;
                    let webcamEntregaStream = null;

                    function startWebcam() {
                        if (webcamStarted) return;
                        const video = document.getElementById('webcam');

                        navigator.mediaDevices.getUserMedia({ video: true })
                            .then(stream => {
                                video.srcObject = stream;
                                webcamStream = stream;
                                webcamStarted = true;
                            })
                            .catch(err => {
                                console.error("Erro ao acessar webcam visitante:", err);
                            });
                    }

                    function pararWebcam() {
                        if (webcamStream) {
                            webcamStream.getTracks().forEach(track => track.stop());
                            webcamStarted = false;
                        }
                    }

                    function tirarFoto() {
                        const video = document.getElementById('webcam');
                        const canvas = document.getElementById('canvas');
                        const input = document.getElementById('id_foto_visitante');
                        const galeria = document.getElementById('galeria-foto-visitante');
                        const imgPreview = document.getElementById('imagem-preview-visitante');

                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        canvas.getContext('2d').drawImage(video, 0, 0);

                        const imageData = canvas.toDataURL('image/jpeg');
                        input.value = imageData;

                        imgPreview.src = imageData;
                        galeria.style.display = 'block';

                        pararWebcam();
                    }


                    function startWebcamServico() {
                        if (webcamServicoStarted) return;
                        const video = document.getElementById('webcam-servico');

                        navigator.mediaDevices.getUserMedia({ video: true })
                            .then(stream => {
                                video.srcObject = stream;
                                webcamServicoStream = stream;
                                webcamServicoStarted = true;
                            })
                            .catch(err => {
                                console.error("Erro ao acessar webcam fornecedor:", err);
                            });
                    }

                    function pararWebcamServico() {
                        if (webcamServicoStream) {
                            webcamServicoStream.getTracks().forEach(track => track.stop());
                            webcamServicoStarted = false;
                        }
                    }
                    function tirarFotoServico() {
                        const video = document.getElementById('webcam-servico');
                        const canvas = document.getElementById('canvas-servico');
                        const input = document.getElementById('id_foto_webcam');
                        const galeria = document.getElementById('galeria-foto-servico');
                        const imgPreview = document.getElementById('imagem-preview-servico');

                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        canvas.getContext('2d').drawImage(video, 0, 0);

                        const imageData = canvas.toDataURL('image/jpeg');
                        input.value = imageData;

                        imgPreview.src = imageData;
                        galeria.style.display = 'block';

                        pararWebcamServico();
                    }


                    function startWebcamEntrega() {
                        if (webcamEntregaStarted) return;
                        const video = document.getElementById('webcam-entrega');

                        navigator.mediaDevices.getUserMedia({ video: true })
                            .then(stream => {
                                video.srcObject = stream;
                                webcamEntregaStream = stream;
                                webcamEntregaStarted = true;
                            })
                            .catch(err => {
                                console.error("Erro ao acessar webcam entrega:", err);
                            });
                    }

                    function pararWebcamEntrega() {
                        if (webcamEntregaStream) {
                            webcamEntregaStream.getTracks().forEach(track => track.stop());
                            webcamEntregaStarted = false;
                        }
                    }

                    function tirarFotoEntrega() {
                        const video = document.getElementById('webcam-entrega');
                        const canvas = document.getElementById('canvas-entrega');
                        const input = document.getElementById('id_foto_entrega');
                        const galeria = document.getElementById('galeria-foto-entrega');
                        const imgPreview = document.getElementById('imagem-preview-entrega');

                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        canvas.getContext('2d').drawImage(video, 0, 0);

                        const imageData = canvas.toDataURL('image/jpeg');
                        input.value = imageData;

                        imgPreview.src = imageData;
                        galeria.style.display = 'block';

                        pararWebcamEntrega();
                    }

                    function removerFotoEntrega() {
                        const input = document.getElementById('id_foto_entrega');
                        const galeria = document.getElementById('galeria-foto-entrega');
                        const imgPreview = document.getElementById('imagem-preview-entrega');

                        input.value = '';
                        imgPreview.src = '';
                        galeria.style.display = 'none';

                        startWebcamEntrega();  // reativa a c√¢mera
                    }
                    function removerFotoVisitante() {
                        const input = document.getElementById('id_foto_visitante');
                        const galeria = document.getElementById('galeria-foto-visitante');
                        const imgPreview = document.getElementById('imagem-preview-visitante');

                        input.value = '';
                        imgPreview.src = '';
                        galeria.style.display = 'none';

                        startWebcam();  // reativa a c√¢mera
                    }

                    function removerFotoServico() {
                        const input = document.getElementById('id_foto_webcam');
                        const galeria = document.getElementById('galeria-foto-servico');
                        const imgPreview = document.getElementById('imagem-preview-servico');

                        input.value = '';
                        imgPreview.src = '';
                        galeria.style.display = 'none';

                        startWebcamServico();  // reativa a c√¢mera
                    }



                    const fornecedorModal = document.getElementById('fornecedorModal');

                    fornecedorModal.addEventListener('show.bs.modal', () => {
                        const categoria = document.getElementById('id_categoria')?.value;

                        document.getElementById('visitanteFields').style.display = 'none';
                        document.getElementById('fornecedorServicoFields').style.display = 'none';
                        document.getElementById('entregaFields').style.display = 'none';
                        document.getElementById('webcam-entrega-container').style.display = 'none';

                        if (categoria === 'VISITANTE') {
                            document.getElementById('visitanteFields').style.display = 'block';
                            startWebcam();
                        } else if (categoria === 'FORNECEDOR') {
                            document.getElementById('fornecedorServicoFields').style.display = 'block';
                            startWebcamServico();
                        } else if (categoria === 'ENTREGA') {
                            document.getElementById('entregaFields').style.display = 'block';
                            document.getElementById('webcam-entrega-container').style.display = 'block';
                            startWebcamEntrega();
                        }
                    });

                    fornecedorModal.addEventListener('hide.bs.modal', () => {
                        pararWebcam();
                        pararWebcamServico();
                        pararWebcamEntrega();

                        document.getElementById('id_foto_visitante').value = '';
                        document.getElementById('id_foto_webcam').value = '';
                        document.getElementById('id_foto_entrega').value = '';
                    });

                    // Atualiza webcams se mudar a categoria manualmente
                    document.getElementById('id_categoria')?.addEventListener('change', () => {
                        fornecedorModal.dispatchEvent(new Event('show.bs.modal'));
                    });
                </script>

                </div>
                <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary" name="submit_novo_fornecedor">Salvar</button>
                </div>
            </form>
            </div>
        </div>
        </div>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const categoriaSelect = document.getElementById('id_categoria');
                const visitanteFields = document.getElementById('visitanteFields');
                const webcamContainer = document.getElementById('webcam-container');
                
                function toggleFields() {
                    const selected = categoriaSelect.value;
                    visitanteFields.style.display = selected === 'VISITANTE' ? 'block' : 'none';
                    webcamContainer.style.display = selected === 'VISITANTE' ? 'block' : 'none';

                    if (selected === 'VISITANTE') {
                        startWebcam();
                    }
                }

                categoriaSelect.addEventListener('change', toggleFields);
                toggleFields();  // Executar no carregamento
            });
        </script>

        <!-- Modal Entrada Fornecedor -->
        <div class="modal fade" id="entradafornecedorModal" tabindex="-1" aria-labelledby="entradafornecedorModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form method="post">
                        {% csrf_token %}
                        <div class="modal-header">
                            <h5 class="modal-title" id="fornecedorModalLabel">Nova Entrada de Fornecedor</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                        </div>
                        <div class="modal-body">
                            {{ form_entrada.as_p }}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary" name="submit_entrada">Salvar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- Tabela Entrada de Fornecedores -->
        <section class="mt-5">
            <h2>Entrada de Fornecedores Cadastrados</h2>
            <div class="mb-3 d-flex flex-wrap gap-3 align-items-end">
                <div>
                    <label for="filtro-data" class="form-label">Data:</label>
                    <input type="date" id="filtro-data" class="form-control" />
                </div>

                <div>
                    <label for="filtro-categoria" class="form-label">Categoria:</label>
                    <select id="filtro-categoria" class="form-control">
                    <option value="">Todos</option>
                    <option value="VISITANTE">Visitante</option>
                    <option value="Fornecedores/Prestadores de Servi√ßos">Fornecedores/Prestadores de Servi√ßos</option>
                    <option value="Entregas">Entregas</option>
                    </select>
                </div>

                <div>
                    <label for="filtro-fornecedor" class="form-label">Fornecedor:</label>
                    <input type="text" id="filtro-fornecedor" class="form-control" placeholder="Nome fornecedor" />
                </div>

                <div>
                    <label for="filtro-responsavel" class="form-label">Respons√°vel:</label>
                    <input type="text" id="filtro-responsavel" class="form-control" placeholder="Assinatura portaria" />
                </div>

                <div>
                    <label for="filtro-status" class="form-label">Status:</label>
                    <select id="filtro-status" class="form-control">
                    <option value="">Todos</option>
                    <option value="Em andamento">Em andamento</option>
                    <option value="Saiu">Saiu</option>
                    </select>
                </div>

            </div>
            <div>
                <table class="table-cadastro" id="tabela-entradas">
                    <thead>
                        <tr>
                            <th>Foto</th>
                            <th>Data</th>
                            <th>Entrada</th>
                            <th>Sa√≠da</th>
                            <th>Base</th>
                            <th>Categoria</th>
                            <th>Fornecedor</th>
                            <th>Respons√°vel</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entrada in entradas %}
                        <tr>
                            <td>
                            {% if entrada.fornecedor.categoria == 'VISITANTE' and entrada.fornecedor.visitante and entrada.fornecedor.visitante.foto_visitante %}
                                <img src="{{ entrada.fornecedor.visitante.foto_visitante.url }}" 
                                    alt="Foto Visitante" 
                                    style="width: 80px; height: 80px; object-fit: cover; border-radius: 50%; border: 2px solid #28a745; cursor: pointer;"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#modalFoto" 
                                    data-foto="{{ entrada.fornecedor.visitante.foto_visitante.url }}">
                            {% elif entrada.fornecedor.categoria == 'FORNECEDOR' and entrada.fornecedor.fornecedor_servico and entrada.fornecedor.fornecedor_servico.foto_fornecedor %}
                                <img src="{{ entrada.fornecedor.fornecedor_servico.foto_fornecedor.url }}" 
                                    alt="Foto Fornecedor" 
                                    style="width: 80px; height: 80px; object-fit: cover; border-radius: 50%; border: 2px solid #28a745; cursor: pointer;"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#modalFoto" 
                                    data-foto="{{ entrada.fornecedor.fornecedor_servico.foto_fornecedor.url }}">
                            {% elif entrada.fornecedor.categoria == 'ENTREGA' and entrada.fornecedor.entrega and entrada.fornecedor.entrega.foto_caixa_entrega %}
                                <img src="{{ entrada.fornecedor.entrega.foto_caixa_entrega.url }}" 
                                    alt="Foto Entrega" 
                                    style="width: 80px; height: 80px; object-fit: cover; border-radius: 50%; border: 2px solid #28a745; cursor: pointer;"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#modalFoto" 
                                    data-foto="{{ entrada.fornecedor.entrega.foto_caixa_entrega.url }}">
                            {% else %}
                                <span>‚Äî</span>
                            {% endif %}
                            </td>
                            <td>{{ entrada.data|date:"d/m/Y" }}</td>
                            <td>{{ entrada.horario_entrada|time:"H:i" }}</td>
                            <td>
                                {% if entrada.status == "Saiu" %}
                                    {{ entrada.horario_saida|time:"H:i" }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ entrada.base }}</td>
                            <td>{{ entrada.fornecedor.get_categoria_display }}</td>
                            <td>{{ entrada.get_nome_fornecedor }}</td>
                            <td>{{ entrada.assinatura_portaria }}</td>
                            <td>{{ entrada.status }}</td>
                            <td>
                                {% if entrada.status != "Saiu" %}
                                    <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#confirmarSaidaModal{{ entrada.id }}">
                                        Registrar Sa√≠da
                                    </button>
                                    <div class="modal fade" id="confirmarSaidaModal{{ entrada.id }}" tabindex="-1" aria-labelledby="modalLabel{{ entrada.id }}" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <form method="post" action="{% url 'status_fornecedor' entrada.id %}">
                                                    {% csrf_token %}
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="modalLabel{{ entrada.id }}">Confirmar Sa√≠da</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        Tem certeza que deseja registrar a sa√≠da do fornecedor <strong>{{ entrada.fornecedor }}</strong>?
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                                        <button type="submit" class="btn btn-danger">Confirmar</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <span>‚úÖ</span>
                                {% endif %}

                                <!-- Bot√£o Ver Detalhes -->
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalDetalhes{{ entrada.id }}">
                                    Ver Detalhes
                                </button>

                                <!-- Bot√£o Excluir -->
                                <form method="post" action="{% url 'excluir_entrada' entrada.id %}" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Tem certeza que deseja excluir este registro?');">
                                        Excluir
                                    </button>
                                </form>
                            </td>
                        </tr>






                        <!-- Modal de detalhes aprimorado -->
                        <div class="modal fade" id="modalDetalhes{{ entrada.id }}" tabindex="-1" aria-labelledby="modalDetalhesLabel{{ entrada.id }}" aria-hidden="true">
                            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                                <div class="modal-content">
                                    <div class="modal-header bg-primary text-white">
                                        <h5 class="modal-title" id="modalDetalhesLabel{{ entrada.id }}">
                                            <i class="fas fa-info-circle me-2"></i>Detalhes da Entrada: {{ entrada.fornecedor.get_categoria_display }}
                                        </h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                                    </div>

                                    <div class="modal-body bg-light">
                                        <div class="container-fluid">
                                            <!-- Se√ß√£o de Informa√ß√µes Gerais -->
                                            <div class="card mb-4 shadow-sm">
                                                <div class="card-header">
                                                    <h6 class="mb-0">Informa√ß√µes Gerais da Entrada</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-md-4">
                                                            <p><strong><i class="fas fa-calendar-alt text-primary me-2"></i>Data:</strong> {{ entrada.data|date:"d/m/Y" }}</p>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <p><strong><i class="fas fa-sign-in-alt text-success me-2"></i>Entrada:</strong> {{ entrada.horario_entrada|time:"H:i" }}</p>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <p><strong><i class="fas fa-sign-out-alt text-danger me-2"></i>Sa√≠da:</strong>
                                                                {% if entrada.horario_saida %}
                                                                    {{ entrada.horario_saida|time:"H:i" }}
                                                                {% else %}
                                                                    <span class="badge bg-warning text-dark">N√£o registrada</span>
                                                                {% endif %}
                                                            </p>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <p><strong><i class="fas fa-building text-primary me-2"></i>Base:</strong> {{ entrada.base }}</p>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <p><strong><i class="fas fa-traffic-light text-primary me-2"></i>Status:</strong>
                                                                {% if entrada.status == 'Em andamento' %}
                                                                    <span class="badge bg-success">{{ entrada.status }}</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">{{ entrada.status }}</span>
                                                                {% endif %}
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Se√ß√£o de Detalhes Espec√≠ficos da Categoria -->
                                            <div class="card shadow-sm">
                                                <div class="card-header">
                                                    <h6 class="mb-0">Detalhes do {{ entrada.fornecedor.get_categoria_display }}</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <!-- Coluna para a Foto -->
                                                        <div class="col-md-4 text-center">
                                                            {% if entrada.fornecedor.categoria == 'VISITANTE' and entrada.fornecedor.visitante.foto_visitante %}
                                                                <img src="{{ entrada.fornecedor.visitante.foto_visitante.url }}" class="img-fluid rounded shadow-lg mb-3" alt="Foto do Visitante" style="max-height: 250px;">
                                                            {% elif entrada.fornecedor.categoria == 'FORNECEDOR' and entrada.fornecedor.fornecedor_servico.foto_fornecedor %}
                                                                <img src="{{ entrada.fornecedor.fornecedor_servico.foto_fornecedor.url }}" class="img-fluid rounded shadow-lg mb-3" alt="Foto do Fornecedor" style="max-height: 250px;">
                                                            {% elif entrada.fornecedor.categoria == 'ENTREGA' and entrada.fornecedor.entrega.foto_caixa_entrega %}
                                                                <img src="{{ entrada.fornecedor.entrega.foto_caixa_entrega.url }}" class="img-fluid rounded shadow-lg mb-3" alt="Foto da Entrega" style="max-height: 250px;">
                                                            {% else %}
                                                                <div class="d-flex align-items-center justify-content-center bg-secondary-subtle rounded text-muted mb-3" style="height: 250px;">
                                                                    <i class="fas fa-camera fa-3x"></i>
                                                                    <p class="ms-2 mb-0">Sem foto</p>
                                                                </div>
                                                            {% endif %}
                                                        </div>

                                                        <!-- Coluna para os Dados -->
                                                        <div class="col-md-8">
                                                            {% if entrada.fornecedor.categoria == 'VISITANTE' and entrada.fornecedor.visitante %}
                                                                <p><strong>Nome:</strong> {{ entrada.fornecedor.visitante.nome }}</p>
                                                                <p><strong>Documento:</strong> {{ entrada.fornecedor.visitante.documento }}</p>
                                                                <p><strong>Motivo da Visita:</strong> {{ entrada.fornecedor.visitante.motivo_visita }}</p>
                                                                <hr>
                                                                <p><strong>Setor de Destino:</strong> {{ entrada.setor_destino }}</p>
                                                                <p><strong>Respons√°vel Autorizante:</strong> {{ entrada.responsavel_autorizante }}</p>
                                                                <p><strong>Ve√≠culo:</strong> {{ entrada.modelo_veiculo|default:"N√£o informado" }} - {{ entrada.placa_veiculo|default:"N/A" }}</p>

                                                            {% elif entrada.fornecedor.categoria == 'FORNECEDOR' and entrada.fornecedor.fornecedor_servico %}
                                                                <p><strong>Empresa:</strong> {{ entrada.fornecedor.fornecedor_servico.nome_empresa }}</p>
                                                                <p><strong>Representante:</strong> {{ entrada.fornecedor.fornecedor_servico.nome_representante }}</p>
                                                                <p><strong>Documento:</strong> {{ entrada.fornecedor.fornecedor_servico.documento }}</p>
                                                                <p><strong>Atividade/Servi√ßo:</strong> {{ entrada.fornecedor.fornecedor_servico.atividade_servico }}</p>
                                                                <hr>
                                                                <p><strong>Setor de Destino:</strong> {{ entrada.setor_destino }}</p>
                                                                <p><strong>Respons√°vel Autorizante:</strong> {{ entrada.responsavel_autorizante }}</p>
                                                                <p><strong>Ve√≠culo:</strong> {{ entrada.modelo_veiculo|default:"N√£o informado" }} - {{ entrada.placa_veiculo|default:"N/A" }}</p>

                                                            {% elif entrada.fornecedor.categoria == 'ENTREGA' and entrada.fornecedor.entrega %}
                                                                <p><strong>Entregador:</strong> {{ entrada.fornecedor.entrega.nome_entregador }}</p>
                                                                <p><strong>Transportadora:</strong> {{ entrada.fornecedor.entrega.nome_transportadora }}</p>
                                                                <p><strong>Tipo de Entrega:</strong> {{ entrada.fornecedor.entrega.tipo_entrega }}</p>
                                                                <p><strong>Descri√ß√£o do Item:</strong> {{ entrada.fornecedor.entrega.descricao_item }}</p>
                                                                <hr>
                                                                <p><strong>Setor de Destino:</strong> {{ entrada.setor_destino }}</p>
                                                                <p><strong>Documentos:</strong> {{ entrada.fornecedor.entrega.documentos_entregador }}</p>
                                                                <p><strong>Ve√≠culo (Placa):</strong> {{ entrada.placa_veiculo|default:"N√£o informado" }}</p>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                            <i class="fas fa-times me-2"></i>Fechar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                        {% empty %}
                        <tr><td colspan="8">Nenhuma entrada registrada</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
        <div class="modal fade" id="modalFoto" tabindex="-1" aria-labelledby="modalFotoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg"> 
            <div class="modal-content bg-transparent border-0">
            <div class="modal-body p-0 text-center">
                <img src="" id="fotoExpandida" style="width: 100%; max-height: 80vh; object-fit: contain; border-radius: 10px;">
            </div>
            <div class="modal-footer justify-content-center border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
            </div>
        </div>
        </div>

    </div>
    <script>
        const modalFoto = document.getElementById('modalFoto')
        const fotoExpandida = document.getElementById('fotoExpandida')

        modalFoto.addEventListener('show.bs.modal', event => {
            const triggerElement = event.relatedTarget // elemento que acionou o modal (imagem clicada)
            const urlFoto = triggerElement.getAttribute('data-foto')
            fotoExpandida.src = urlFoto
        })
    </script>

    <script>
        // Seleciona os inputs
        const filtroData = document.getElementById('filtro-data');
        const filtroCategoria = document.getElementById('filtro-categoria');
        const filtroFornecedor = document.getElementById('filtro-fornecedor');
        const filtroResponsavel = document.getElementById('filtro-responsavel');
        const filtroStatus = document.getElementById('filtro-status');
        const tabela = document.getElementById('tabela-entradas').getElementsByTagName('tbody')[0];

        // Fun√ß√£o para limpar espa√ßos e padronizar texto para compara√ß√£o
        function normalizeString(str) {
            return str.trim().toLowerCase();
        }

        // Fun√ß√£o que realiza o filtro
        function filtrarTabela() {
            const valData = filtroData.value; // formato: yyyy-mm-dd
            const valCategoria = normalizeString(filtroCategoria.value);
            const valFornecedor = normalizeString(filtroFornecedor.value);
            const valResponsavel = normalizeString(filtroResponsavel.value);
            const valStatus = normalizeString(filtroStatus.value);

            // Percorre todas as linhas da tabela (tbody)
            for (let row of tabela.rows) {
                // Ajuste dos √≠ndices das c√©lulas para corresponder ao HTML
                const celData = row.cells[1].innerText; // "dd/mm/yyyy"
                const celCategoria = normalizeString(row.cells[5].innerText);
                const celFornecedor = normalizeString(row.cells[6].innerText);
                const celResponsavel = normalizeString(row.cells[7].innerText);
                const celStatus = normalizeString(row.cells[8].innerText);

                // Converter data da c√©lula para yyyy-mm-dd para comparar com o filtro
                const parts = celData.split('/');
                const dataFormatada = parts.length === 3 ? `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}` : '';

                // Verifica cada filtro (se preenchido)
                const passaData = !valData || dataFormatada === valData;
                const passaCategoria = !valCategoria || celCategoria.includes(valCategoria);
                const passaFornecedor = !valFornecedor || celFornecedor.includes(valFornecedor);
                const passaResponsavel = !valResponsavel || celResponsavel.includes(valResponsavel);
                const passaStatus = !valStatus || celStatus.includes(valStatus);

                // Se passar todos, mostra a linha, sen√£o esconde
                if (passaData && passaCategoria && passaFornecedor && passaResponsavel && passaStatus) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        }

        // Adiciona eventos para rodar o filtro quando algo mudar
        filtroData.addEventListener('change', filtrarTabela);
        filtroCategoria.addEventListener('change', filtrarTabela);
        filtroFornecedor.addEventListener('input', filtrarTabela);
        filtroResponsavel.addEventListener('input', filtrarTabela);
        filtroStatus.addEventListener('change', filtrarTabela);


    </script>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const categoriaSelect = document.querySelector('#id_categoria');
        const visitanteFields = document.getElementById('visitanteFields');
        const fornecedorServicoFields = document.getElementById('fornecedorServicoFields');
        const entregaFields = document.getElementById('entregaFields');

        // Fun√ß√£o para mostrar/esconder e habilitar/desabilitar campos
        function toggleFields() {
            const categoria = categoriaSelect.value;

            // Esconde e desabilita todos os campos
            [visitanteFields, fornecedorServicoFields, entregaFields].forEach(fieldset => {
                fieldset.style.display = 'none';
                fieldset.querySelectorAll('input, select, textarea').forEach(input => {
                    input.disabled = true;
                });
            });

            // Exibe e habilita somente os campos da categoria escolhida
            if (categoria === 'VISITANTE') {
                visitanteFields.style.display = 'block';
                visitanteFields.querySelectorAll('input, select, textarea').forEach(input => {
                    input.disabled = false;
                });
            } else if (categoria === 'FORNECEDOR') {
                fornecedorServicoFields.style.display = 'block';
                fornecedorServicoFields.querySelectorAll('input, select, textarea').forEach(input => {
                    input.disabled = false;
                });
            } else if (categoria === 'ENTREGA') {
                entregaFields.style.display = 'block';
                entregaFields.querySelectorAll('input, select, textarea').forEach(input => {
                    input.disabled = false;
                });
            }
        }

        // Evento quando o usu√°rio muda a categoria
        categoriaSelect.addEventListener('change', toggleFields);

        // Executa ao carregar a p√°gina
        toggleFields();
    });
    </script>


    <!-- Scripts -->
    <script>
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('toggleSidebarBtn');

        toggleBtn.addEventListener('click', () => {
            sidebar.classList.toggle('reduzida');
        });
    </script>





    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>