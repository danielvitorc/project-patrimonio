{% load static %}
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Fornecedores - PATRIMONIO{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'patrimonio/css/visitantes.css' %}">

    <!-- Favicon -->
    <link rel="icon"
        href="https://encrypted-tbn2.gstatic.com/faviconV2?url=https://www.nortetech.net&amp;client=VFE&amp;size=64&amp;type=FAVICON&amp;fallback_opts=TYPE,SIZE,URL&amp;nfrp=2"
        type="image/png">
</head>

<body>
    {% include 'patrimonio/includes/sidebar.html' %}
    <div class="main-content" id="mainContent">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Fornecedores Cadastrados</h1>
            <!-- Botão de Ações com Dropdown -->
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownAcoes" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-cog me-2"></i>Ações
                </button>
                <ul class="dropdown-menu" aria-labelledby="dropdownAcoes">
                    <li>
                        <h6 class="dropdown-header">
                            <i class="fas fa-file-excel me-2"></i>Exportar para Excel
                        </h6>
                    </li>
                    <li>
                        <a class="dropdown-item" href="{% url 'exportar_visitantes_excel' %}">
                            <i class="fas fa-user me-2"></i>Visitantes
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="{% url 'exportar_fornecedores_servico_excel' %}">
                            <i class="fas fa-building me-2"></i>Fornecedores/Prestadores de Serviços
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="{% url 'exportar_fornecedores_excel' %}">
                            <i class="fas fa-file-excel me-2"></i>Exportação Completa
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- ================================================================== -->
        <!-- INÍCIO DO CARD DE FILTROS RECOLHÍVEL                               -->
        <!-- ================================================================== -->
        <div class="card shadow-sm mb-4">
            <!-- Cabeçalho Clicável -->
            <div class="card-header bg-white p-3 collapsible-header" data-bs-toggle="collapse"
                data-bs-target="#filterCollapse" aria-expanded="true">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-funnel-fill me-2"></i>Filtros de Pesquisa</h5>
                </div>
            </div>

            <!-- Conteúdo do Filtro (que recolhe) -->
            <div class="collapse show" id="filterCollapse">
                <div class="card-body p-4">
                    <form id="filter-form" method="get" class="row g-3 align-items-end">
                        <!-- Campo Data -->
                        <div class="col-md-3">
                            <label for="filtro-data" class="form-label fw-bold">Data de Integração:</label>
                            <input type="date" id="filtro-data" class="form-control" />
                        </div>
                        <!-- Campo Categoria -->
                        <div class="col-md-3">
                            <label for="filtro-categoria" class="form-label fw-bold">Categoria:</label>
                            <select id="filtro-categoria" class="form-select">
                                <option value="">Todas</option>
                                <option value="Visitante">Visitante</option>
                                <option value="Fornecedores/Prestadores de Serviços">Fornecedores/Prestadores de
                                    Serviços</option>
                                <option value="Entregas">Entregas</option>
                            </select>
                        </div>
                        <!-- Campo Fornecedor -->
                        <div class="col-md-3">
                            <label for="filtro-fornecedor" class="form-label fw-bold">Fornecedor:</label>
                            <input type="text" id="filtro-fornecedor" class="form-control" placeholder="Buscar nome" />
                        </div>
                        <!-- Campo Status -->
                        <div class="col-md-3">
                            <label for="filtro-status" class="form-label fw-bold">Status:</label>
                            <select id="filtro-status" class="form-select">
                                <option value="">Todos</option>
                                <option value="Integrado">Integrado</option>
                                <option value="Pendente">Pendente</option>
                            </select>
                        </div>
                        <!-- Botões -->
                        <div class="col-12 mt-3">
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <button type="button" onclick="aplicarFiltros()" class="btn btn-primary w-100">
                                        <i class="bi bi-search me-2"></i>Pesquisar
                                    </button>
                                </div>
                                <div class="col-md-2">
                                    <a href="#" onclick="limparFiltros(event)" class="btn btn-outline-secondary w-100"
                                        title="Limpar Filtros">
                                        <i class="bi bi-x-lg"></i> Limpar
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- ================================================================== -->
        <!-- FIM DO CARD DE FILTROS RECOLHÍVEL                                  -->
        <!-- ================================================================== -->

        <!-- Informativo sobre exportação -->
        <div class="alert alert-info d-flex align-items-center mb-4" role="alert">
            <i class="fas fa-info-circle me-2"></i>
            <div>
                <strong>Exportação por categoria:</strong> Use o botão 
                <span class="badge bg-secondary">Ações</span> para acessar as opções de exportação para Excel: 
                <span class="badge bg-success">Visitantes</span>, 
                <span class="badge bg-primary">Fornecedores/Prestadores</span> ou 
                <span class="badge bg-info">Completa</span>.
            </div>
        </div>

        <section class="mt-4">
            <table class="table-cadastro">
                <thead>
                    <tr>
                        <th width="80">Foto</th>
                        <th width="140">Categoria</th>
                        <th>Nome/Empresa</th>
                        <th width="120">Integração</th>
                        <th width="100">Validade</th>
                        <th width="100">Status</th>
                        <th width="120">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for fornecedor in fornecedores %}
                    <tr>
                        <td class="text-center">
                            {% if fornecedor.categoria == 'VISITANTE' and fornecedor.visitante and fornecedor.visitante.foto_visitante %}
                                <img src="{{ fornecedor.visitante.foto_visitante.url }}" alt="Foto" class="foto-tabela"
                                    data-bs-toggle="modal" data-bs-target="#modalFoto"
                                    data-foto="{{ fornecedor.visitante.foto_visitante.url }}">
                            {% elif fornecedor.categoria == 'FORNECEDOR' and fornecedor.fornecedor_servico and fornecedor.fornecedor_servico.foto_fornecedor %}
                                <img src="{{ fornecedor.fornecedor_servico.foto_fornecedor.url }}" alt="Foto" class="foto-tabela"
                                    data-bs-toggle="modal" data-bs-target="#modalFoto"
                                    data-foto="{{ fornecedor.fornecedor_servico.foto_fornecedor.url }}">
                            {% elif fornecedor.categoria == 'ENTREGA' and fornecedor.entrega and fornecedor.entrega.foto_caixa_entrega %}
                                <img src="{{ fornecedor.entrega.foto_caixa_entrega.url }}" alt="Foto" class="foto-tabela"
                                    data-bs-toggle="modal" data-bs-target="#modalFoto"
                                    data-foto="{{ fornecedor.entrega.foto_caixa_entrega.url }}">
                            {% else %}
                                <div class="foto-placeholder">
                                    <i class="bi bi-person"></i>
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            <span class="categoria-badge categoria-{{ fornecedor.categoria|lower }}">
                                {% if fornecedor.categoria == 'VISITANTE' %}
                                <i class="bi bi-person-check me-1"></i>Visitante
                                {% elif fornecedor.categoria == 'FORNECEDOR' %}
                                <i class="bi bi-building me-1"></i>Fornecedor
                                {% else %}
                                <i class="bi bi-box-seam me-1"></i>Entrega
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <div class="nome-info">
                                {% if fornecedor.categoria == "VISITANTE" and fornecedor.visitante %}
                                <strong>{{ fornecedor.visitante.nome }}</strong>
                                {% elif fornecedor.categoria == "FORNECEDOR" and fornecedor.fornecedor_servico %}
                                <strong>{{ fornecedor.fornecedor_servico.nome_empresa }}</strong>
                                <br><small class="text-muted">{{ fornecedor.fornecedor_servico.nome_representante }}</small>
                                {% elif fornecedor.categoria == "ENTREGA" and fornecedor.entrega %}
                                <strong>{{ fornecedor.entrega.nome_transportadora }}</strong>
                                <br><small class="text-muted">{{ fornecedor.entrega.nome_entregador }}</small>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="text-center">{{ fornecedor.data_integracao|date:"d/m/Y" }}</td>
                        <td class="text-center">
                            <div class="validade-info">
                                <strong>{{ fornecedor.validade_meses }} meses</strong>
                                <br><small class="text-muted">{{ fornecedor.data_validade|date:"d/m/Y" }}</small>
                            </div>
                        </td>
                        <td class="text-center">
                            {% if fornecedor.status == "Integrado" %}
                            <span class="badge bg-success">
                                <i class="bi bi-check-circle me-1"></i>Integrado
                            </span>
                            {% else %}
                            <span class="badge bg-warning">
                                <i class="bi bi-exclamation-circle me-1"></i>Pendente
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button"
                                    data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal"
                                            data-bs-target="#modalDetalhes{{ fornecedor.id }}">
                                            <i class="bi bi-eye me-2"></i>Ver Detalhes
                                        </a></li>
                                    <li><a class="dropdown-item btn-editar" href="#" data-id="{{ fornecedor.id }}">
                                            <i class="bi bi-pencil me-2"></i>Editar
                                        </a></li>
                                    <li>
                                        <hr class="dropdown-divider">
                                    </li>
                                    <li><a class="dropdown-item text-danger btn-excluir" href="#"
                                            data-id="{{ fornecedor.id }}">
                                            <i class="bi bi-trash me-2"></i>Excluir
                                        </a></li>
                                </ul>
                            </div>
                        </td>
                    </tr>

                    <!-- ================================================================== -->
                    <!-- INÍCIO DO MODAL DE DETALHES CORRIGIDO E FUNCIONAL                 -->
                    <!-- ================================================================== -->
                    <div class="modal fade" id="modalDetalhes{{ fornecedor.id }}" tabindex="-1"
                        aria-labelledby="modalDetalhesLabel{{ fornecedor.id }}" aria-hidden="true">
                        <div class="modal-dialog modal-xl modal-dialog-scrollable">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title" id="modalDetalhesLabel{{ fornecedor.id }}">
                                        <i class="fas fa-info-circle me-2"></i>Detalhes de: {{
                                        fornecedor.get_categoria_display }}
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                        aria-label="Fechar"></button>
                                </div>

                                <div class="modal-body bg-light">
                                    <div class="container-fluid">
                                        <!-- Seção de Informações Gerais do Cadastro -->
                                        <div class="card mb-4 shadow-sm">
                                            <div class="card-header">
                                                <h6 class="mb-0">Informações do Cadastro</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <p><strong><i class="fas fa-id-card text-primary me-2"></i>ID do Cadastro:</strong> {{ fornecedor.id }}</p>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <p><strong><i class="fas fa-calendar-alt text-primary me-2"></i>Data de Integração:</strong> {{ fornecedor.data_integracao|date:"d/m/Y" }}</p>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <p><strong><i class="fas fa-calendar-times text-danger me-2"></i>Data de Validade:</strong> {{ fornecedor.data_validade|date:"d/m/Y" }}</p>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <p><strong><i class="fas fa-traffic-light text-primary me-2"></i>Status:</strong>
                                                            {% if fornecedor.status == 'Integrado' %}
                                                            <span class="badge bg-success">{{ fornecedor.status }}</span>
                                                            {% else %}
                                                            <span class="badge bg-danger">{{ fornecedor.status }}</span>
                                                            {% endif %}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Seção de Detalhes Específicos da Categoria -->
                                        <div class="card shadow-sm">
                                            <div class="card-header">
                                                <h6 class="mb-0">Detalhes Específicos do {{
                                                    fornecedor.get_categoria_display }}</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <!-- Coluna para a Foto -->
                                                    <div class="col-md-4 text-center">
                                                        {% if fornecedor.categoria == 'VISITANTE' and fornecedor.visitante.foto_visitante %}
                                                        <img src="{{ fornecedor.visitante.foto_visitante.url }}"
                                                            class="img-fluid rounded shadow-lg mb-3"
                                                            alt="Foto do Visitante" style="max-height: 250px;">
                                                        {% elif fornecedor.categoria == 'FORNECEDOR' and fornecedor.fornecedor_servico.foto_fornecedor %}
                                                        <img src="{{ fornecedor.fornecedor_servico.foto_fornecedor.url }}"
                                                            class="img-fluid rounded shadow-lg mb-3"
                                                            alt="Foto do Fornecedor" style="max-height: 250px;">
                                                        {% else %}
                                                        <div class="d-flex align-items-center justify-content-center bg-secondary-subtle rounded text-muted mb-3"
                                                            style="height: 250px;">
                                                            <i class="fas fa-camera fa-3x"></i>
                                                            <p class="ms-2 mb-0">Sem foto</p>
                                                        </div>
                                                        {% endif %}
                                                    </div>

                                                    <!-- Coluna para os Dados -->
                                                    <div class="col-md-8">
                                                        {% if fornecedor.categoria == 'VISITANTE' and fornecedor.visitante %}
                                                        <p><strong><i class="fas fa-user me-2"></i>Nome:</strong> {{fornecedor.visitante.nome }}</p>
                                                        <p><strong><i class="fas fa-id-badge me-2"></i>Documento:</strong> {{ fornecedor.visitante.documento }}</p>
                                                        <p><strong><i class="fas fa-question-circle me-2"></i>Motivo da Visita:</strong> {{fornecedor.visitante.motivo_visita }}</p>
                                                        {% elif fornecedor.categoria == 'FORNECEDOR' and fornecedor.fornecedor_servico %}
                                                        <p><strong><i class="fas fa-building me-2"></i>Empresa:</strong> {{ fornecedor.fornecedor_servico.nome_empresa }}</p>
                                                        <p><strong><i class="fas fa-user-tie me-2"></i>Representante:</strong> {{ fornecedor.fornecedor_servico.nome_representante }}</p>
                                                        <p><strong><i class="fas fa-id-badge me-2"></i>Documento:</strong> {{ fornecedor.fornecedor_servico.documento }}</p>
                                                        <p><strong><i class="fas fa-tools me-2"></i>Atividade/Serviço:</strong> {{ fornecedor.fornecedor_servico.atividade_servico }}</p>
                                                        {% else %}
                                                        <p class="text-muted">Não há detalhes específicos para esta
                                                            categoria.</p>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="fas fa-times me-2"></i>Fechar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- ================================================================== -->
                    <!-- FIM DO MODAL DE DETALHES CORRIGIDO                                 -->
                    <!-- ================================================================== -->

                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center">Nenhum fornecedor cadastrado.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- ================================================================== -->
            <!-- INÍCIO DO CONTROLE DE PAGINAÇÃO                                    -->
            <!-- ================================================================== -->
            <div class="d-flex justify-content-between align-items-center mt-4">
                <span id="pagination-info" class="text-muted"></span>
                <nav>
                    <ul class="pagination" id="pagination-controls">
                        <!-- Os botões da paginação serão gerados aqui pelo JavaScript -->
                    </ul>
                </nav>
            </div>
            <!-- ================================================================== -->
            <!-- FIM DO CONTROLE DE PAGINAÇÃO                                       -->
            <!-- ================================================================== -->
        </section>
    </div>

    <!-- Outros Modais (Edição, Foto) e Scripts -->
    <!-- Modal de Edição -->
    <div class="modal fade" id="modalEditarFornecedor" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="formEditarFornecedor" method="post" action="">
                    <div class="modal-header">
                        <h5 class="modal-title">Editar Fornecedor</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="modal-body-content">
                        <!-- Campos do formulário vão ser carregados aqui -->
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Salvar</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal de Foto -->
    <div class="modal fade" id="modalFoto" tabindex="-1" aria-labelledby="modalFotoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-transparent border-0">
                <div class="modal-body p-0 text-center">
                    <img src="" id="fotoExpandida"
                        style="width: 100%; max-height: 80vh; object-fit: contain; border-radius: 10px;">
                </div>
                <div class="modal-footer justify-content-center border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(function () {
            $('.btn-editar').on('click', function () {
                let id = $(this).data('id');
                $.get(`/fornecedor/modal_editar/${id}/`, function (data) {
                    $('#modal-body-content').html(data.form_html);
                    $('#formEditarFornecedor').attr('action', `/fornecedor/modal_editar/${id}/`);
                    $('#modalEditarFornecedor').modal('show');
                });
            });


            $('#formEditarFornecedor').on('submit', function (e) {
                e.preventDefault();
                let form = $(this);

                $.ajax({
                    url: form.attr('action'),
                    type: 'POST',
                    data: form.serialize(),
                    success: function (data) {
                        if (data.success) {
                            location.reload();  // recarrega para mostrar as alterações
                        } else {
                            $('#modal-body-content').html(data.form_html); // mostrar erros de validação
                        }
                    }
                });
            });

        });
    </script>
    <script>
        // Função para pegar o CSRF token do cookie (padrão Django)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // Configura o AJAX do jQuery para enviar o token automaticamente
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!(/^GET|HEAD|OPTIONS|TRACE$/.test(settings.type)) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        // Lógica para o botão Excluir funcionar via AJAX
        $(document).on('click', '.btn-excluir', function () {
            if (!confirm('Tem certeza que deseja excluir este fornecedor?')) {
                return; // cancelou exclusão
            }

            let id = $(this).data('id');
            $.ajax({
                url: `/fornecedor/excluir/${id}/`,
                type: 'POST',
                success: function (data) {
                    if (data.success) {
                        alert('Fornecedor excluído com sucesso.');
                        location.reload();
                    } else {
                        alert('Erro ao excluir fornecedor.');
                    }
                },
                error: function () {
                    alert('Erro ao tentar excluir fornecedor.');
                }
            });
        });
    </script>
    <script>           
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('toggleSidebarBtn');

        toggleBtn.addEventListener('click', () => {
            sidebar.classList.toggle('reduzida');        
        });
    </script>
    <script>
        const modalFoto = document.getElementById('modalFoto')
        const fotoExpandida = document.getElementById('fotoExpandida')

        modalFoto.addEventListener('show.bs.modal', event => {
            const triggerElement = event.relatedTarget // elemento que acionou o modal (imagem clicada)
            const urlFoto = triggerElement.getAttribute('data-foto')
            fotoExpandida.src = urlFoto
        })
    </script>
    
    <!-- ================================================================== -->
    <!-- SCRIPT DE PAGINAÇÃO E FILTRO COMBINADOS                            -->
    <!-- ================================================================== -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // --- VARIÁVEIS GLOBAIS PARA PAGINAÇÃO E FILTRO ---
            const registrosPorPagina = 10;
            let paginaAtual = 1;
            const tabelaBody = document.querySelector(".table-cadastro tbody");
            const todasAsLinhas = Array.from(tabelaBody.querySelectorAll("tr"));
            let linhasFiltradas = todasAsLinhas;

            const paginationControls = document.getElementById("pagination-controls");
            const paginationInfo = document.getElementById("pagination-info");

            // --- FUNÇÕES DE PAGINAÇÃO ---
            function exibirPagina(pagina) {
                paginaAtual = pagina;
                tabelaBody.innerHTML = "";

                const inicio = (pagina - 1) * registrosPorPagina;
                const fim = inicio + registrosPorPagina;
                const linhasDaPagina = linhasFiltradas.slice(inicio, fim);

                linhasDaPagina.forEach(linha => tabelaBody.appendChild(linha));

                const totalFiltrado = linhasFiltradas.length;
                const inicioInfo = totalFiltrado > 0 ? inicio + 1 : 0;
                const fimInfo = Math.min(fim, totalFiltrado);
                paginationInfo.textContent = `Mostrando ${inicioInfo} a ${fimInfo} de ${totalFiltrado} registros`;
            }

            function setupPagination() {
                paginationControls.innerHTML = "";
                const totalDePaginas = Math.ceil(linhasFiltradas.length / registrosPorPagina);

                if (totalDePaginas <= 1) {
                    paginationInfo.textContent = `Mostrando ${linhasFiltradas.length} registros`;
                    return;
                }

                // Botão "Anterior"
                let liPrev = `<li class="page-item ${paginaAtual === 1 ? 'disabled' : ''}">
                            <a class="page-link" href="#" onclick="mudarPagina(event, ${paginaAtual - 1})">Anterior</a>
                          </li>`;
                paginationControls.innerHTML += liPrev;

                // Botões de página numerados (máximo 5 páginas visíveis)
                let startPage = Math.max(1, paginaAtual - 2);
                let endPage = Math.min(totalDePaginas, startPage + 4);

                if (endPage - startPage < 4) {
                    startPage = Math.max(1, endPage - 4);
                }

                for (let i = startPage; i <= endPage; i++) {
                    let li = `<li class="page-item ${i === paginaAtual ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="mudarPagina(event, ${i})">${i}</a>
                          </li>`;
                    paginationControls.innerHTML += li;
                }

                // Botão "Próximo"
                let liNext = `<li class="page-item ${paginaAtual === totalDePaginas ? 'disabled' : ''}">
                            <a class="page-link" href="#" onclick="mudarPagina(event, ${paginaAtual + 1})">Próximo</a>
                          </li>`;
                paginationControls.innerHTML += liNext;
            }

            // --- FUNÇÃO PARA MUDAR PÁGINA ---
            window.mudarPagina = function(event, novaPagina) {
                event.preventDefault();
                const totalDePaginas = Math.ceil(linhasFiltradas.length / registrosPorPagina);
                
                if (novaPagina >= 1 && novaPagina <= totalDePaginas) {
                    exibirPagina(novaPagina);
                    setupPagination();
                }
            }

            // --- FUNÇÕES DE FILTRO ---
            function aplicarFiltros() {
                const filtroData = document.getElementById("filtro-data").value;
                const filtroCategoria = document.getElementById("filtro-categoria").value.toLowerCase();
                const filtroFornecedor = document.getElementById("filtro-fornecedor").value.toLowerCase();
                const filtroStatus = document.getElementById("filtro-status").value.toLowerCase();

                linhasFiltradas = todasAsLinhas.filter(linha => {
                    // Pular linhas vazias (como a linha "Nenhum fornecedor cadastrado")
                    if (linha.cells.length < 7) return false;

                    const dataIntegracao = linha.cells[3].textContent.trim();
                    const categoria = linha.cells[1].textContent.trim().toLowerCase();
                    const nomeEmpresa = linha.cells[2].textContent.trim().toLowerCase();
                    const status = linha.cells[5].textContent.trim().toLowerCase();

                    // Filtro por data
                    if (filtroData) {
                        const dataFormatada = new Date(filtroData).toLocaleDateString('pt-BR');
                        if (!dataIntegracao.includes(dataFormatada)) return false;
                    }

                    // Filtro por categoria
                    if (filtroCategoria && !categoria.includes(filtroCategoria)) return false;

                    // Filtro por nome/empresa
                    if (filtroFornecedor && !nomeEmpresa.includes(filtroFornecedor)) return false;

                    // Filtro por status
                    if (filtroStatus && !status.includes(filtroStatus)) return false;

                    return true;
                });

                paginaAtual = 1; // Resetar para primeira página
                exibirPagina(paginaAtual);
                setupPagination();
            }

            function limparFiltros(event) {
                event.preventDefault();
                document.getElementById("filtro-data").value = "";
                document.getElementById("filtro-categoria").value = "";
                document.getElementById("filtro-fornecedor").value = "";
                document.getElementById("filtro-status").value = "";
                
                linhasFiltradas = todasAsLinhas;
                paginaAtual = 1;
                exibirPagina(paginaAtual);
                setupPagination();
            }

            // Tornar as funções globais
            window.aplicarFiltros = aplicarFiltros;
            window.limparFiltros = limparFiltros;

            // --- INICIALIZAÇÃO ---
            exibirPagina(1);
            setupPagination();
        });
    </script>

</body>
</html>

